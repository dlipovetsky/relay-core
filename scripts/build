#!/bin/bash

set -euo pipefail

build_images() {
    for cmd in ./cmd/*; do
        local command_name="$(basename "${cmd}")"

        source "${cmd}"/build-info.sh

        docker_file=Dockerfile."${command_name}"
        include=scripts/Dockerfile.include
        if [ -f "${cmd}"/Dockerfile.include ]; then
            include="${cmd}"/Dockerfile.include
        fi

        cp scripts/Dockerfile.template "${docker_file}"
        cat "${include}" >> "${docker_file}"

        sed -i "s|__OUTPUTBIN__|${command_name}|g" "${docker_file}"
        sed -i "s|__GOMAIN__|./cmd/${command_name}|g" "${docker_file}"
        sed -i "s|__DOCKER_CMD__|${DOCKER_CMD}|g" "${docker_file}"

        docker build -f "${docker_file}" -t "${DOCKER_REPO}:${VERSION}" .

        rm "${docker_file}"

        echo "${DOCKER_REPO}:${VERSION}" >> "${RELEASE_MANIFEST}"
    done
}

# this ensures that we are in the correct directory context
cd "$(dirname "$0")"/..

build_images
